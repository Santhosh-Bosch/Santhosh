<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Telemetry Dashboard - Fleet Operations India</title>
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Google Fonts for Modern Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            animation: gradientShift 15s ease infinite;
            background-size: 400% 400%;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .header .subtitle {
            color: #666;
            font-size: 16px;
        }

        .header .india-flag {
            display: inline-block;
            margin-left: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 28px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card-title {
            font-size: 13px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 18px;
            font-weight: 700;
        }

        .card-value {
            font-size: 52px;
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1;
            letter-spacing: -1px;
        }

        .card-unit {
            font-size: 20px;
            color: #999;
            font-weight: normal;
        }

        .speed-card .card-value {
            color: #4CAF50;
        }

        .battery-card .card-value {
            color: #2196F3;
        }

        .gps-card .card-value {
            color: #FF9800;
            font-size: 24px;
        }

        .progress-bar {
            width: 100%;
            height: 28px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 14px;
            overflow: hidden;
            margin-top: 18px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .progress-fill.low {
            background: linear-gradient(90deg, #ef4444, #f87171);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        .progress-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .progress-percentage {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: bold;
            color: #666;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        .status.good {
            background: #e8f5e9;
            color: #4CAF50;
        }

        .status.warning {
            background: #fff3e0;
            color: #ff9800;
        }

        .status.danger {
            background: #ffebee;
            color: #f44336;
        }

        .timestamp {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: inline-block;
        }

        .map-container {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .map-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .map-coordinates {
            font-size: 14px;
            color: #666;
        }

        .map-controls {
            display: flex;
            gap: 10px;
        }

        .map-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            font-family: 'Inter', sans-serif;
        }

        .map-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .map-btn:active {
            transform: scale(0.98);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .alert-banner {
            background: linear-gradient(135deg, #ff5252, #f48fb1);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .alert-banner.show {
            display: flex;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: linear-gradient(135deg, #ff5252, #ff1744);
            color: white;
            padding: 18px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(255, 23, 68, 0.4);
            font-weight: 700;
            font-size: 16px;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
        }

        .notification-icon {
            font-size: 24px;
            animation: ring 0.5s ease-in-out infinite;
        }

        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        .notification-close {
            margin-left: 10px;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .history-chart {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            color: #6b7280;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .chart-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f3f4f6;
        }

        .chart-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Vehicle Telemetry Dashboard <span class="india-flag">üáÆüá≥</span></h1>
            <div class="subtitle">Real-time Fleet Operations Monitoring - Coimbatore, Tamil Nadu</div>
        </div>

        <div id="speedNotification" class="notification">
            <span class="notification-icon">üö®</span>
            <span id="notificationMessage"></span>
            <span class="notification-close" onclick="closeNotification()">‚úï</span>
        </div>

        <div id="alertBanner" class="alert-banner">
            ‚ö†Ô∏è <span id="alertMessage"></span>
        </div>

        <div class="refresh-indicator">
            üîÑ Live Updates | Fleet: <span id="fleetCount">10</span> Vehicles
        </div>

        <div class="dashboard">
            <!-- Speed Card -->
            <div class="card speed-card">
                <div class="icon">üöó</div>
                <div class="card-title">Vehicle Speed</div>
                <div class="card-value">
                    <span id="speed">0.00</span> <span class="card-unit">km/h</span>
                </div>
                <div class="progress-bar">
                    <div id="speedProgress" class="progress-fill" style="width: 0%"></div>
                    <div class="progress-percentage" id="speedPercentage">0%</div>
                </div>
                <div id="speedStatus" class="status good">‚úì Normal Speed</div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Max Speed</div>
                        <div class="stat-value" id="maxSpeed">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Speed</div>
                        <div class="stat-value" id="avgSpeed">0</div>
                    </div>
                </div>
            </div>

            <!-- Battery Card -->
            <div class="card battery-card">
                <div class="icon">üîã</div>
                <div class="card-title">Battery Level</div>
                <div class="card-value">
                    <span id="battery">0.00</span> <span class="card-unit">%</span>
                </div>
                <div class="progress-bar">
                    <div id="batteryProgress" class="progress-fill" style="width: 0%"></div>
                    <div class="progress-percentage" id="batteryPercentage">0%</div>
                </div>
                <div id="batteryStatus" class="status good">‚úì Battery Good</div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Voltage</div>
                        <div class="stat-value" id="voltage">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Range</div>
                        <div class="stat-value" id="range">--</div>
                    </div>
                </div>
            </div>

            <!-- GPS Card -->
            <div class="card gps-card">
                <div class="icon">üìç</div>
                <div class="card-title">GPS Location</div>
                <div style="margin: 15px 0;">
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Latitude</div>
                        <div class="card-value"><span id="latitude">0.000000</span>¬∞</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Longitude</div>
                        <div class="card-value"><span id="longitude">0.000000</span>¬∞</div>
                    </div>
                </div>
                <div class="status good">‚úì GPS Signal Active</div>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <div class="map-info">
                    <div>
                        <h2 style="margin: 0; color: #333;">üó∫Ô∏è Live Fleet Map - Coimbatore</h2>
                        <div class="map-coordinates">
                            Tracking: <span id="mapLat">0.000000</span>¬∞, <span id="mapLon">0.000000</span>¬∞ | 
                            <strong>Fleet Size: <span id="mapFleetCount">10</span> vehicles</strong>
                        </div>
                    </div>
                    <div class="map-controls">
                        <button class="map-btn" onclick="centerMap()">üìç Center</button>
                        <button class="map-btn" onclick="toggleMapType()">üó∫Ô∏è Satellite</button>
                    </div>
                </div>
                <div id="map"></div>
            </div>

            <!-- History Chart -->
            <div class="history-chart">
                <div class="chart-header">
                    <h2 class="chart-title">üìä Telemetry History</h2>
                    <div class="chart-controls">
                        <button class="chart-btn active" onclick="changeChartMetric('speed')">Speed</button>
                        <button class="chart-btn" onclick="changeChartMetric('battery')">Battery</button>
                        <button class="chart-btn" onclick="changeChartMetric('both')">Both</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="telemetryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="timestamp">
            Last Updated: <span id="timestamp">--</span>
        </div>
    </div>

    <!-- Leaflet JS for Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Chart.js for Telemetry Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Configuration
        const UPDATE_INTERVAL = 2000; // 2 seconds
        const SPEED_LIMIT = 100; // km/h
        const SPEED_NOTIFICATION_THRESHOLD = 80; // km/h - Show notification
        const BATTERY_LOW = 20; // %
        const BATTERY_MEDIUM = 50; // %
        const FLEET_SIZE = 10; // Number of vehicles

        // Statistics tracking
        let speedHistory = [];
        let maxSpeedRecorded = 0;

        // Map variables
        let map;
        let vehicleMarker;
        let locationCircle;
        let pathPolyline;
        let locationHistory = [];
        let currentMapType = 'street';
        let satelliteLayer;
        let streetLayer;

        // Fleet management (10 vehicles)
        let fleetVehicles = [];
        let fleetMarkers = [];
        let fleetPaths = [];
        let selectedVehicleId = 0; // Currently displayed vehicle
        let lastNotificationTime = 0;

        // Chart variables
        let telemetryChart;
        let chartData = {
            labels: [],
            speedData: [],
            batteryData: []
        };
        let currentChartMetric = 'speed';
        const MAX_CHART_POINTS = 20;

        // Initialize the map
        function initMap() {
            // Create map centered on Coimbatore, India (Tamil Nadu)
            // Coimbatore coordinates: 11.0168¬∞ N, 76.9558¬∞ E
            map = L.map('map').setView([11.0168, 76.9558], 13);

            // Street map layer (OpenStreetMap)
            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Satellite layer (ESRI World Imagery)
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri',
                maxZoom: 19
            });

            // Initialize fleet of 10 vehicles
            const vehicleColors = [
                '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
                '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16'
            ];

            for (let i = 0; i < FLEET_SIZE; i++) {
                // Random starting position around Coimbatore
                const lat = 11.0168 + (Math.random() - 0.5) * 0.08;
                const lon = 76.9558 + (Math.random() - 0.5) * 0.08;

                // Create vehicle data
                const vehicle = {
                    id: i,
                    name: `Vehicle ${i + 1}`,
                    latitude: lat,
                    longitude: lon,
                    speed: 30 + Math.random() * 50,
                    batteryLevel: 50 + Math.random() * 40,
                    history: [[lat, lon]],
                    color: vehicleColors[i]
                };
                fleetVehicles.push(vehicle);

                // Custom vehicle icon with realistic image
                const vehicleIcon = L.divIcon({
                    className: 'custom-vehicle-marker',
                    html: `<div style="width: 40px; height: 40px; position: relative;">
                        <img src="https://cdn-icons-png.flaticon.com/512/3097/3097150.png" 
                             style="width: 100%; height: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)) hue-rotate(${i * 36}deg);"
                             onerror="this.style.display='none'; this.parentNode.innerHTML='üöó';"
                             alt="Vehicle ${i + 1}">
                        <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); 
                                    background: ${vehicleColors[i]}; color: white; padding: 2px 6px; 
                                    border-radius: 10px; font-size: 10px; font-weight: bold; 
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.3); white-space: nowrap;">
                            V${i + 1}
                        </div>
                    </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                // Create marker
                const marker = L.marker([lat, lon], { icon: vehicleIcon }).addTo(map);
                marker.bindPopup(`
                    <div style="font-family: Arial, sans-serif;">
                        <b>üöó ${vehicle.name}</b><br>
                        <b>Speed:</b> ${vehicle.speed.toFixed(1)} km/h<br>
                        <b>Battery:</b> ${vehicle.batteryLevel.toFixed(1)}%<br>
                        <b>Location:</b> ${lat.toFixed(6)}¬∞, ${lon.toFixed(6)}¬∞
                    </div>
                `);

                // Add click handler to select vehicle
                marker.on('click', function() {
                    selectedVehicleId = i;
                    updateDashboard(fleetVehicles[i]);
                });

                fleetMarkers.push(marker);

                // Create path polyline for each vehicle
                const path = L.polyline([[lat, lon]], {
                    color: vehicleColors[i],
                    weight: 2,
                    opacity: 0.6
                }).addTo(map);
                fleetPaths.push(path);
            }

            // Set up the main display for Vehicle 1
            vehicleMarker = fleetMarkers[0];
            locationCircle = L.circle([fleetVehicles[0].latitude, fleetVehicles[0].longitude], {
                color: vehicleColors[0],
                fillColor: vehicleColors[0],
                fillOpacity: 0.1,
                radius: 50
            }).addTo(map);
            pathPolyline = fleetPaths[0];
            locationHistory = fleetVehicles[0].history;
        }

        // Update map with new location (for selected vehicle display)
        function updateMap(data) {
            const newLatLng = [data.latitude, data.longitude];
            
            // Update the location circle for selected vehicle
            locationCircle.setLatLng(newLatLng);
            locationCircle.setStyle({
                color: fleetVehicles[selectedVehicleId].color,
                fillColor: fleetVehicles[selectedVehicleId].color
            });
        }

        // Center map on current location
        function centerMap() {
            if (vehicleMarker) {
                map.setView(vehicleMarker.getLatLng(), 15);
            }
        }

        // Toggle between street and satellite view
        function toggleMapType() {
            const btn = event.target;
            if (currentMapType === 'street') {
                map.removeLayer(streetLayer);
                map.addLayer(satelliteLayer);
                currentMapType = 'satellite';
                btn.textContent = 'üó∫Ô∏è Street';
            } else {
                map.removeLayer(satelliteLayer);
                map.addLayer(streetLayer);
            currentMapType = 'street';
            btn.textContent = 'üó∫Ô∏è Satellite';
        }
    }

    // Initialize the chart
    function initChart() {
        const ctx = document.getElementById('telemetryChart').getContext('2d');
        
        telemetryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Speed (km/h)',
                    data: chartData.speedData,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgb(16, 185, 129)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                family: 'Inter',
                                size: 13,
                                weight: '600'
                            },
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            family: 'Inter',
                            size: 14,
                            weight: '700'
                        },
                        bodyFont: {
                            family: 'Inter',
                            size: 13
                        },
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                    if (context.dataset.label.includes('Speed')) {
                                        label += ' km/h';
                                    } else {
                                        label += ' %';
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: 'Inter',
                                size: 11
                            },
                            maxRotation: 0
                        }
                    },
                    y: {
                        display: true,
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                family: 'Inter',
                                size: 11
                            }
                        }
                    }
                },
                animation: {
                    duration: 750,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    // Update chart with new data
    function updateChart(data) {
        const timeLabel = new Date().toLocaleTimeString('en-IN', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false 
        });

        // Add new data
        chartData.labels.push(timeLabel);
        chartData.speedData.push(data.speed);
        chartData.batteryData.push(data.batteryLevel);

        // Keep only last MAX_CHART_POINTS
        if (chartData.labels.length > MAX_CHART_POINTS) {
            chartData.labels.shift();
            chartData.speedData.shift();
            chartData.batteryData.shift();
        }

        // Update chart based on current metric
        updateChartDisplay();
    }

    // Change chart metric display
    function changeChartMetric(metric) {
        currentChartMetric = metric;
        
        // Update button states
        document.querySelectorAll('.chart-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        updateChartDisplay();
    }

    // Update chart display based on selected metric
    function updateChartDisplay() {
        if (!telemetryChart) return;

        if (currentChartMetric === 'speed') {
            telemetryChart.data.datasets = [{
                label: 'Speed (km/h)',
                data: chartData.speedData,
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: 'rgb(16, 185, 129)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }];
            telemetryChart.options.scales.y.max = 120;
        } else if (currentChartMetric === 'battery') {
            telemetryChart.data.datasets = [{
                label: 'Battery Level (%)',
                data: chartData.batteryData,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: 'rgb(59, 130, 246)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }];
            telemetryChart.options.scales.y.max = 100;
        } else { // both
            telemetryChart.data.datasets = [
                {
                    label: 'Speed (km/h)',
                    data: chartData.speedData,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgb(16, 185, 129)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'Battery Level (%)',
                    data: chartData.batteryData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgb(59, 130, 246)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1'
                }
            ];
            
            // Add second y-axis for battery when showing both
            telemetryChart.options.scales.y1 = {
                type: 'linear',
                display: true,
                position: 'right',
                max: 100,
                grid: {
                    drawOnChartArea: false
                },
                ticks: {
                    font: {
                        family: 'Inter',
                        size: 11
                    }
                }
            };
            telemetryChart.options.scales.y.max = 120;
        }

        telemetryChart.data.labels = chartData.labels;
        telemetryChart.update('none'); // Update without animation for smoother experience
    }

        // Update all vehicles in the fleet
        function updateAllVehicles() {
            for (let i = 0; i < FLEET_SIZE; i++) {
                const vehicle = fleetVehicles[i];
                
                // Simulate speed change
                vehicle.speed = Math.max(20, Math.min(110, vehicle.speed + (Math.random() - 0.5) * 10));
                
                // Simulate battery drain (slow discharge)
                vehicle.batteryLevel = Math.max(10, vehicle.batteryLevel - Math.random() * 0.5);
                
                // Update position (random walk)
                const lastPos = vehicle.history[vehicle.history.length - 1];
                vehicle.latitude = lastPos[0] + (Math.random() - 0.5) * 0.001;
                vehicle.longitude = lastPos[1] + (Math.random() - 0.5) * 0.001;
                
                // Update history
                vehicle.history.push([vehicle.latitude, vehicle.longitude]);
                if (vehicle.history.length > 50) {
                    vehicle.history.shift();
                }
                
                // Update marker position
                fleetMarkers[i].setLatLng([vehicle.latitude, vehicle.longitude]);
                
                // Update marker popup
                fleetMarkers[i].setPopupContent(`
                    <div style="font-family: Arial, sans-serif;">
                        <b>üöó ${vehicle.name}</b><br>
                        <b>Speed:</b> ${vehicle.speed.toFixed(1)} km/h 
                        ${vehicle.speed > SPEED_NOTIFICATION_THRESHOLD ? '‚ö†Ô∏è' : ''}
                        ${vehicle.speed > SPEED_LIMIT ? 'üö®' : ''}<br>
                        <b>Battery:</b> ${vehicle.batteryLevel.toFixed(1)}%<br>
                        <b>Location:</b> ${vehicle.latitude.toFixed(6)}¬∞, ${vehicle.longitude.toFixed(6)}¬∞
                    </div>
                `);
                
                // Update path
                fleetPaths[i].setLatLngs(vehicle.history);
                
                // Check for speed notification (80 km/h threshold)
                if (vehicle.speed > SPEED_NOTIFICATION_THRESHOLD) {
                    const now = Date.now();
                    // Show notification max once every 5 seconds
                    if (now - lastNotificationTime > 5000) {
                        showSpeedNotification(vehicle.name, vehicle.speed);
                        lastNotificationTime = now;
                    }
                }
            }
        }

        // Simulate telemetry data (for backward compatibility)
        function fetchTelemetryData() {
            // Return data for the currently selected vehicle
            const vehicle = fleetVehicles[selectedVehicleId];
            return {
                speed: parseFloat(vehicle.speed.toFixed(2)),
                batteryLevel: parseFloat(vehicle.batteryLevel.toFixed(2)),
                latitude: parseFloat(vehicle.latitude.toFixed(6)),
                longitude: parseFloat(vehicle.longitude.toFixed(6)),
                timestamp: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
                vehicleName: vehicle.name
            };
        }

        function updateDashboard(data) {
            // Update speed
            document.getElementById('speed').textContent = data.speed.toFixed(2);
            const speedPercent = Math.min((data.speed / 120) * 100, 100);
            document.getElementById('speedProgress').style.width = speedPercent + '%';
            document.getElementById('speedPercentage').textContent = speedPercent.toFixed(0) + '%';
            
            // Speed status
            const speedStatus = document.getElementById('speedStatus');
            const speedProgress = document.getElementById('speedProgress');
            if (data.speed > SPEED_LIMIT) {
                speedStatus.className = 'status danger';
                speedStatus.textContent = '‚ö†Ô∏è High Speed Alert!';
                speedProgress.className = 'progress-fill low';
                showAlert('High Speed Detected: ' + data.speed.toFixed(2) + ' km/h');
            } else if (data.speed > 60) {
                speedStatus.className = 'status warning';
                speedStatus.textContent = '‚ö†Ô∏è Moderate Speed';
                speedProgress.className = 'progress-fill medium';
            } else {
                speedStatus.className = 'status good';
                speedStatus.textContent = '‚úì Normal Speed';
                speedProgress.className = 'progress-fill';
            }

            // Track speed statistics
            speedHistory.push(data.speed);
            if (speedHistory.length > 10) speedHistory.shift();
            maxSpeedRecorded = Math.max(maxSpeedRecorded, data.speed);
            const avgSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;
            
            document.getElementById('maxSpeed').textContent = maxSpeedRecorded.toFixed(0);
            document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(0);

            // Update battery
            document.getElementById('battery').textContent = data.batteryLevel.toFixed(2);
            document.getElementById('batteryProgress').style.width = data.batteryLevel + '%';
            document.getElementById('batteryPercentage').textContent = data.batteryLevel.toFixed(0) + '%';
            
            // Battery status
            const batteryStatus = document.getElementById('batteryStatus');
            const batteryProgress = document.getElementById('batteryProgress');
            if (data.batteryLevel < BATTERY_LOW) {
                batteryStatus.className = 'status danger';
                batteryStatus.textContent = '‚ö†Ô∏è Low Battery!';
                batteryProgress.className = 'progress-fill low';
                showAlert('Low Battery: ' + data.batteryLevel.toFixed(2) + '%');
            } else if (data.batteryLevel < BATTERY_MEDIUM) {
                batteryStatus.className = 'status warning';
                batteryStatus.textContent = '‚ö†Ô∏è Battery Moderate';
                batteryProgress.className = 'progress-fill medium';
            } else {
                batteryStatus.className = 'status good';
                batteryStatus.textContent = '‚úì Battery Good';
                batteryProgress.className = 'progress-fill';
            }

            // Battery details
            const voltage = (data.batteryLevel / 100 * 48).toFixed(1); // Simulated voltage
            const range = (data.batteryLevel / 100 * 300).toFixed(0); // Simulated range in km
            document.getElementById('voltage').textContent = voltage + 'V';
            document.getElementById('range').textContent = range + ' km';

            // Update GPS
            document.getElementById('latitude').textContent = data.latitude.toFixed(6);
            document.getElementById('longitude').textContent = data.longitude.toFixed(6);
            document.getElementById('mapLat').textContent = data.latitude.toFixed(6);
            document.getElementById('mapLon').textContent = data.longitude.toFixed(6);

            // Update timestamp
            document.getElementById('timestamp').textContent = data.timestamp;

            // Update map
            updateMap(data);

            // Update chart
            updateChart(data);
        }

        let alertTimeout;
        function showAlert(message) {
            const banner = document.getElementById('alertBanner');
            const messageEl = document.getElementById('alertMessage');
            
            messageEl.textContent = message;
            banner.classList.add('show');
            
            clearTimeout(alertTimeout);
            alertTimeout = setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
        }

        // Show speed notification for 80+ km/h
        function showSpeedNotification(vehicleName, speed) {
            const notification = document.getElementById('speedNotification');
            const message = document.getElementById('notificationMessage');
            
            message.textContent = `${vehicleName} exceeding 80 km/h! Current: ${speed.toFixed(1)} km/h`;
            notification.classList.add('show');
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 8000);
            
            // Play notification sound (optional - browser may block)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWm98OScTgwOUKnn7rZjHAU7k9r0yX4qBSJ1xe/ekkALFFux6OyrVRUJSKHh8r1qIAUsgs/y2Ik2Bxlo');
                audio.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
                // Ignore audio errors
            }
        }

        function closeNotification() {
            document.getElementById('speedNotification').classList.remove('show');
        }

        // Initialize and update
        function update() {
            // Update all 10 vehicles
            updateAllVehicles();
            
            // Update the dashboard with selected vehicle data
            const data = fetchTelemetryData();
            updateDashboard(data);
        }

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            // Initialize the map
            initMap();
            
            // Initialize the chart
            initChart();
            
            // Start updates
            update();
            setInterval(update, UPDATE_INTERVAL);
            
            console.log('Vehicle Telemetry Dashboard Initialized - Coimbatore Fleet Operations');
            console.log(`Fleet Size: ${FLEET_SIZE} vehicles`);
            console.log('Location: Coimbatore, Tamil Nadu, India');
            console.log('Speed Notification Threshold: 80 km/h');
            console.log('Live map with OpenStreetMap - Ready!');
            console.log('Live chart with Chart.js - Ready!');
        });
    </script>
</body>
</html>
